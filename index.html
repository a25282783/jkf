<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>老司機最懂你</title>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="Shortcut Icon" type="image/x-icon" href="/favicon-32x32.png">
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<style>
    .img-fluid{
        max-width: 200px;
        height: auto;
    }
    .loading{
        height: 100%;
        width: 100%;
        position: fixed;
        left: 0;
        top: 0;
        background-color: gray;
        opacity: 0.3;
        z-index: 99999999;
    }
</style>
</head>
<body>
    <div class="container-fluid" id="app">
        <div v-show="loading" class="loading">
            <img src="loading.gif" style="width: 100%;">
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="page-header">
                    <h1>老司機最懂你
                        <!-- <small>現在第: <?php echo $page; ?>頁</small> -->
                        <span class="label label-info"> 總共:{{ Object.keys(totalpage).length }}頁</span>
                    </h1>
                </div>
            </div>
        </div>
        <button @click="clearLocalStorage()">清除緩存</button>
        <button @click="clearKeyWord()">清除關鍵字</button>
        <br>
        <form >
            <div class="form-group">
                <label for="keyWord">關鍵字</label>
                <input type="text" class="form-control" id="keyWord" placeholder="吹...刪除可全搜" name="keyWord" v-model="key" value="{{ key }}">
            </div>
        </form>
        <button @click="getByPage(0)">走起</button>
        <hr>
        <div class="row" style="padding-bottom: 50px">
            <div class="col-md-9">
        
                <div class="row">
                    <div class="col-md-10">
                        <p><strong>結果:</strong></p>
                    </div>
                </div>
                <!-- table -->
                <table class="table table-striped">
                    <thead >
                        <tr>
                        <th scope="col">頭像</th>
                        <th scope="col">連結</th>
                        <th scope="col">內文</th>
                        </tr>
                    </thead>
                    <tbody>
                      </div>
                        <tr v-for="hooker in hooker_list" :key="hooker.url">
                        <td><img :src="hooker.avatar" class="img-fluid"><br>{{ hooker.title }}</td>
                        <td><a :href="hooker.url" target="_blank">{{ hooker.url }}</a></td>
                        <td>{{ hooker.content }}</td>
                        </tr>
                    </tbody>
                </table>
                <!-- table -->
                <br>
                <div v-show="!has_keyWord">
                    <form >
                        <div class="form-group">
                            <label for="select">現在第{{ nowpage }}頁</label>
                            <select class="form-control" id="select" v-model="selected">
                                <option v-for="index in totalpage" :key="index">
                                    {{ index.substr(4) }}
                                </option>
                            </select>
                        </div>                    
                    </form>
                    <button @click="getByPage(selected,'prev')" >上一頁</button>
                    <button @click="getByPage(selected)" >走起</button>
                    <button @click="getByPage(selected,'next')" >下一頁</button>
                </div>
            </div>
        </div>

    </div>
    <script>
        var vm = new Vue({
            el:'#app',
            data:{
                hooker_list:null,
                totalpage:null,
                nowpage:0,
                selected: '',
                has_keyWord:false,
                loading:false,
                key:''
            },
            mounted:function(){
                this.getTotalPage();
                this.getByPage(0);
            },
            methods:{
                getTotalPage:function() {
                    jkftotalpage = localStorage.getItem("jkftotalpage");
                    if(!jkftotalpage){
                        axios
                        .get('./data.json')
                        .then(
                            response => (                          
                                localStorage.setItem("jkftotalpage",Object.keys(response.data)),
                                jkftotalpage = localStorage.getItem("jkftotalpage"),
                                this.totalpage = jkftotalpage.split(',')
                            ),
                        )
                        .catch(function (error) {
                            console.log(error);
                        });
                    }
                    setTimeout(()=>{
                        this.totalpage = jkftotalpage.split(',')
                    },1000)
                },
                getByPage:function(page,move=null) {
                    page = parseInt(page)
                    if(page<0){
                        page=0
                    }
                    if(move=='prev'){
                        page-=1
                    }else if(move=='next'){
                        page+=1
                    }
                    var index = "page"+page;
                    var obj = localStorage.getItem(index);
                    // console.log(index)
                    if(!obj){
                        //async
                        axios
                        .get('./data.json')
                        .then(
                            response => (
                                localStorage.setItem(index,JSON.stringify(response.data[index])),
                                this.hooker_list = this.filterByKeyWord(response.data[index])
                            ),
                        )
                        .catch(function (error) {
                            console.log(error);
                        });
                    }else{
                        this.hooker_list = this.filterByKeyWord(JSON.parse(obj))
                    }
                    this.nowpage = page
                    this.selected = page
                    window.scrollTo(0,0)
                    
                },
                filterByKeyWord:function(obj) {
                    if(this.key!==''){
                        let key = this.key
                        var obj = obj.filter(function(item, index, array){
                            return item.content.includes(key); 
                        })
                    }
                    return obj
                    
                },
                // parse:function(obj) {
                //     var arr = Object.keys(obj)
                //     // console.log(arr)
                //     arr.forEach(index => {
                //         if(!localStorage.getItem(index)){
                //             localStorage.setItem(index,JSON.stringify(obj[index])); 
                //         }
                //         console.log(obj[index]);
                //         for()
                        
                //     });
                //     // close mask
                //     this.loading = false
                // },
                clearKeyWord:function() {
                    this.has_keyWord=false
                    this.key=''
                    this.getByPage(0);
                },
                clearLocalStorage:function() {
                    localStorage.clear();
                    this.getTotalPage();
                    this.getByPage(0)
                }
            }
        });
    </script>
</body>
</html>
  